{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">Procesamiento de Video</h2>
                </div>
                
                <div class="card-body">
                    <h4 class="card-title">{{ project.title }}</h4>
                    <p class="card-text">{{ project.description }}</p>
                    
                    <div id="processingStatus" class="mt-4">
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar"
                                 aria-valuenow="{{ processing_task.progress }}"
                                 aria-valuemin="0"
                                 aria-valuemax="100"
                                 style="width: {{ processing_task.progress }}%">
                                {{ processing_task.progress }}%
                            </div>
                        </div>
                        
                        <div class="alert alert-info" id="statusMessage">
                            {% if processing_task.status == 'pending' %}
                                Esperando para iniciar el procesamiento...
                            {% elif processing_task.status == 'processing' %}
                                Procesando tu video...
                            {% elif processing_task.status == 'completed' %}
                                ¡El procesamiento ha finalizado exitosamente!
                            {% elif processing_task.status == 'failed' %}
                                Ha ocurrido un error: {{ processing_task.error_message }}
                            {% endif %}
                        </div>
                        
                        {% if processing_task.status == 'completed' and processing_task.output_file %}
                            <div class="text-center mt-4">
                                <a href="{{ processing_task.output_file.url }}" 
                                   class="btn btn-success"
                                   download>
                                    <i class="fas fa-download"></i>
                                    Descargar Video
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            Iniciado: 
                            {% if processing_task.started_at %}
                                {{ processing_task.started_at|date:"d/m/Y H:i:s" }}
                            {% else %}
                                Pendiente
                            {% endif %}
                        </small>
                        
                        <small class="text-muted">
                            Finalizado: 
                            {% if processing_task.completed_at %}
                                {{ processing_task.completed_at|date:"d/m/Y H:i:s" }}
                            {% else %}
                                En proceso
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <a href="{% url 'video_app:project_detail' project.id %}" 
                   class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Volver al Proyecto
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const projectId = {{ project.id }};
        const progressBar = document.querySelector('.progress-bar');
        const statusMessage = document.querySelector('#statusMessage');
        
        function updateProgress() {
            fetch(`/video/project/${projectId}/processing-status/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Actualizar barra de progreso
                progressBar.style.width = `${data.progress}%`;
                progressBar.setAttribute('aria-valuenow', data.progress);
                progressBar.textContent = `${data.progress}%`;
                
                // Actualizar mensaje de estado
                let message = '';
                switch(data.status) {
                    case 'pending':
                        message = 'Esperando para iniciar el procesamiento...';
                        break;
                    case 'processing':
                        message = 'Procesando tu video...';
                        break;
                    case 'completed':
                        message = '¡El procesamiento ha finalizado exitosamente!';
                        if (data.output_url) {
                            location.reload(); // Recargar para mostrar el botón de descarga
                        }
                        break;
                    case 'failed':
                        message = `Ha ocurrido un error: ${data.error_message}`;
                        break;
                }
                statusMessage.textContent = message;
                
                // Continuar actualizando si no ha terminado
                if (data.status === 'pending' || data.status === 'processing') {
                    setTimeout(updateProgress, 2000);
                }
            })
            .catch(error => {
                console.error('Error al actualizar el progreso:', error);
                statusMessage.textContent = 'Error al obtener el estado del procesamiento';
            });
        }
        
        // Iniciar actualización si el estado es pending o processing
        if ('{{ processing_task.status }}' === 'pending' || 
            '{{ processing_task.status }}' === 'processing') {
            updateProgress();
        }
    });
</script>
{% endblock %} 