{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="project-detail-container">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'dashboard' %}">Dashboard</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'project_list' %}">Proyectos</a>
                    </li>
                    <li class="breadcrumb-item active">{{ project.title }}</li>
                </ol>
            </nav>
            <h1>{{ project.title }}</h1>
            <p class="text-muted">{{ project.description }}</p>
        </div>
        <div class="btn-toolbar gap-2">
            <a href="{% url 'project_edit' project.id %}" class="btn btn-primary">
                <i class="fas fa-edit"></i> Editar
            </a>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                <i class="fas fa-trash"></i> Eliminar
            </button>
        </div>
    </div>
    
    <!-- Estado y Progreso -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-3 text-center">
                    <div class="status-badge mb-2">
                        <span class="badge bg-{{ project.get_status_color }} p-3">
                            <i class="fas fa-{{ project.get_status_icon }} fa-2x"></i>
                        </span>
                    </div>
                    <h4>{{ project.get_status_display }}</h4>
                </div>
                <div class="col-md-9">
                    <div class="progress-info mb-2 d-flex justify-content-between">
                        <span>Progreso</span>
                        <span>{{ project.progress }}%</span>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-{{ project.get_status_color }}" 
                             role="progressbar"
                             style="width: {{ project.progress }}%">
                        </div>
                    </div>
                    {% if project.error_message %}
                    <div class="alert alert-danger mt-3 mb-0">
                        {{ project.error_message }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Detalles del Proyecto -->
        <div class="col-md-8">
            <!-- Información General -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Información General</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl>
                                <dt>Creado</dt>
                                <dd>{{ project.created_at|date:"d/m/Y H:i" }}</dd>
                                
                                <dt>Última Actualización</dt>
                                <dd>{{ project.updated_at|date:"d/m/Y H:i" }}</dd>
                                
                                {% if project.template %}
                                <dt>Plantilla</dt>
                                <dd>{{ project.template.name }}</dd>
                                {% endif %}
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl>
                                <dt>Duración Estimada</dt>
                                <dd>{{ project.template.estimated_duration }} segundos</dd>
                                
                                <dt>Categoría</dt>
                                <dd>{{ project.template.get_category_display }}</dd>
                                
                                <dt>Industria</dt>
                                <dd>{{ project.template.get_industry_display }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Script -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Script</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="editScript()">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                </div>
                <div class="card-body">
                    <div class="script-content">
                        {{ project.script|linebreaks }}
                    </div>
                </div>
            </div>
            
            <!-- Video Base -->
            {% if project.base_media %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Video Base</h5>
                </div>
                <div class="card-body">
                    <div class="ratio ratio-16x9">
                        <video controls>
                            <source src="{{ project.base_media.url }}" type="video/mp4">
                            Tu navegador no soporta la reproducción de video.
                        </video>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Video Generado -->
            {% if project.output_video %}
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Video Generado</h5>
                    <div class="btn-group">
                        <a href="{{ project.output_video.url }}" class="btn btn-sm btn-success" download>
                            <i class="fas fa-download"></i> Descargar
                        </a>
                        <button class="btn btn-sm btn-primary" onclick="shareVideo()">
                            <i class="fas fa-share"></i> Compartir
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="ratio ratio-16x9">
                        <video controls>
                            <source src="{{ project.output_video.url }}" type="video/mp4">
                            Tu navegador no soporta la reproducción de video.
                        </video>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Métricas -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Métricas</h5>
                </div>
                <div class="card-body">
                    {% if project_metrics %}
                    <div class="metrics-grid">
                        <div class="metric-item">
                            <div class="metric-value">{{ project_metrics.processing_time|floatformat:1 }}s</div>
                            <div class="metric-label">Tiempo de Procesamiento</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">{{ project_metrics.media_stats.script_length }}</div>
                            <div class="metric-label">Palabras en Script</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">{{ project_metrics.user_interactions.edits }}</div>
                            <div class="metric-label">Ediciones</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">{{ project_metrics.user_interactions.previews }}</div>
                            <div class="metric-label">Previsualizaciones</div>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">No hay métricas disponibles</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Recomendaciones -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Recomendaciones</h5>
                </div>
                <div class="card-body">
                    {% if content_recommendations %}
                    <div class="recommendations-list">
                        {% if content_recommendations.script %}
                        <div class="recommendation-section">
                            <h6>Script</h6>
                            <ul class="list-unstyled">
                                {% for suggestion in content_recommendations.script.suggestions %}
                                <li class="recommendation-item">
                                    <i class="fas fa-lightbulb text-warning"></i>
                                    {{ suggestion }}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        
                        {% if content_recommendations.media %}
                        <div class="recommendation-section">
                            <h6>Media</h6>
                            <ul class="list-unstyled">
                                {% for suggestion in content_recommendations.media.suggestions %}
                                <li class="recommendation-item">
                                    <i class="fas fa-film text-info"></i>
                                    {{ suggestion }}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center">No hay recomendaciones disponibles</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Historial -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Historial de Cambios</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <div class="timeline-date">{{ project.created_at|date:"d/m/Y H:i" }}</div>
                                <div>Proyecto creado</div>
                            </div>
                        </div>
                        
                        {% if project.status == 'processing' %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-warning"></div>
                            <div class="timeline-content">
                                <div class="timeline-date">{{ project.updated_at|date:"d/m/Y H:i" }}</div>
                                <div>Procesamiento iniciado</div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if project.status == 'completed' %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <div class="timeline-date">{{ project.updated_at|date:"d/m/Y H:i" }}</div>
                                <div>Video generado exitosamente</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                ¿Estás seguro de que deseas eliminar este proyecto?
                Esta acción no se puede deshacer.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <form action="{% url 'project_delete' project.id %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Compartir -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Compartir Video</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Enlace del Video</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="videoUrl" 
                               value="{{ request.scheme }}://{{ request.get_host }}{{ project.output_video.url }}"
                               readonly>
                        <button class="btn btn-outline-primary" onclick="copyVideoUrl()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="share-buttons">
                    <a href="#" class="btn btn-primary" onclick="shareOnFacebook()">
                        <i class="fab fa-facebook"></i> Facebook
                    </a>
                    <a href="#" class="btn btn-info" onclick="shareOnTwitter()">
                        <i class="fab fa-twitter"></i> Twitter
                    </a>
                    <a href="#" class="btn btn-success" onclick="shareOnWhatsApp()">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .project-detail-container {
        padding: 2rem;
    }
    
    .status-badge {
        display: inline-block;
    }
    
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    
    .metric-item {
        text-align: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .metric-value {
        font-size: 1.5rem;
        font-weight: 600;
        color: #0d6efd;
    }
    
    .metric-label {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .recommendation-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid #dee2e6;
    }
    
    .recommendation-item:last-child {
        border-bottom: none;
    }
    
    .recommendation-item i {
        margin-right: 0.5rem;
    }
    
    .timeline {
        position: relative;
        padding-left: 2rem;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 0.5rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #dee2e6;
    }
    
    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
    }
    
    .timeline-marker {
        position: absolute;
        left: -2rem;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        border: 2px solid white;
    }
    
    .timeline-date {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .share-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
function confirmDelete() {
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function shareVideo() {
    const modal = new bootstrap.Modal(document.getElementById('shareModal'));
    modal.show();
}

function copyVideoUrl() {
    const urlInput = document.getElementById('videoUrl');
    urlInput.select();
    document.execCommand('copy');
    alert('URL copiada al portapapeles');
}

function shareOnFacebook() {
    const url = encodeURIComponent(document.getElementById('videoUrl').value);
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
}

function shareOnTwitter() {
    const url = encodeURIComponent(document.getElementById('videoUrl').value);
    const text = encodeURIComponent('¡Mira mi video creado con Video Creator!');
    window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
}

function shareOnWhatsApp() {
    const url = encodeURIComponent(document.getElementById('videoUrl').value);
    const text = encodeURIComponent('¡Mira mi video creado con Video Creator!');
    window.open(`https://wa.me/?text=${text}%20${url}`, '_blank');
}

function editScript() {
    // TODO: Implementar edición inline del script
    alert('Funcionalidad en desarrollo');
}

// WebSocket para actualizaciones en tiempo real
document.addEventListener('DOMContentLoaded', function() {
    if ('{{ project.status }}' === 'processing') {
        const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
        const ws_path = `${ws_scheme}://${window.location.host}/ws/video/{{ project.id }}/`;
        const socket = new WebSocket(ws_path);
        
        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.type === 'status_update') {
                updateProgress(data);
            }
        };
        
        socket.onclose = function() {
            console.log('WebSocket cerrado');
        };
    }
});

function updateProgress(data) {
    const progressBar = document.querySelector('.progress-bar');
    const progressText = document.querySelector('.progress-info span:last-child');
    
    progressBar.style.width = `${data.progress}%`;
    progressText.textContent = `${data.progress}%`;
    
    if (data.status === 'completed') {
        location.reload();
    } else if (data.status === 'error') {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger mt-3';
        errorDiv.textContent = data.message;
        progressBar.parentNode.after(errorDiv);
    }
}
</script>
{% endblock %} 